import streamlit as st
import pandas as pd
import requests

st.set_page_config(page_title=" Дашборд", layout="wide")
st.title(" Дашборд")

u = st.text_input(" Введите API", "http://100.65.143.117/transactions")

try:
    r = requests.get(u)
    r.raise_for_status()
    d = pd.DataFrame(r.json())

    if d.empty:
        st.warning("Нет данных.")
    else:
        d["date"] = pd.to_datetime(d["date"])
        d = d.sort_values("date", ascending=False)

        st.subheader(" Таблица")
        with st.expander("Фильтры", expanded=True):
            f1 = st.multiselect("Отправитель", d["from"].unique())
            f2 = st.multiselect("Получатель", d["to"].unique())
            f3 = st.multiselect("Категория", d["category"].unique())
            f4 = st.date_input("Даты", [])

            if f1:
                d = d[d["from"].isin(f1)]
            if f2:
                d = d[d["to"].isin(f2)]
            if f3:
                d = d[d["category"].isin(f3)]
            if f4 and len(f4) == 2:
                d = d[(d["date"] >= pd.to_datetime(f4[0])) & (d["date"] <= pd.to_datetime(f4[1]))]

        st.dataframe(d, use_container_width=True)

        st.subheader("Цифры")
        a, b, c = st.columns(3)
        a.metric(" Сумма", f"{d['amount'].sum():,.2f}")
        b.metric("Транзакции", len(d))
        c.metric(" Средняя", f"{d['amount'].mean():,.2f}")

        st.subheader(" Категории")
        g = d.groupby("category")["amount"].sum().reset_index()
        st.bar_chart(g.set_index("category"))

        st.subheader(" По датам")
        t = d.groupby("date")["amount"].sum().reset_index()
        st.line_chart(t.set_index("date"))

except Exception as e:
    st.error(f"Ошибка: {e}")